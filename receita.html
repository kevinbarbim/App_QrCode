<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conecta Saúde - Sua Receita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --text-color: #343a40;
            --chat-bubble-user: #e2f0fe;
            --chat-bubble-bot: #f1f1f1;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-size: 16px; 
        }
        header {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
    header .logo {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
           
         
        }
        header .logo img {
            width: 100%;   /* A imagem ocupa 100% da largura do contêiner */
            height: 100%;  /* A imagem ocupa 100% da altura do contêiner */
           
            display: block; /* Remove possíveis espaços extras da imagem */
        }
        header .app-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }
        .container-custom {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .medication-section {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 0;
        }
        .medication-section h4 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .medication-section p {
            font-size: 1rem;
            color: #6c757d;
        }
        .medication-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 15px;
            border-radius: 8px;
            transition: background-color 0.2s;
            border: 1px solid #eee;
        }
        .medication-item:last-child {
            margin-bottom: 0;
        }
        .medication-item.selected {
            background-color: #e2f0fe;
            border-color: var(--primary-color);
        }
        .medication-item input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            outline: none;
            transition: all 0.2s ease-in-out;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .medication-item input[type="radio"]:checked {
            background-color: #000;
            border-color: #000;
            position: relative;
        }
        .medication-item input[type="radio"]:checked::after {
            content: "\f26b";
            font-family: "bootstrap-icons";
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        .medication-details h5 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .medication-details p {
            margin-bottom: 0;
            font-size: 1rem;
            color: var(--text-color);
        }
        .medication-details p.small {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .chat-section {
            background-color: #fff;
            border: 1px solid #000;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 70vh;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            padding: 15px 20px 10px 20px;
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .chat-bubble {
            padding: 12px 18px;
            border-radius: 18px;
            margin-bottom: 10px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 1rem;
        }
        .chat-bubble-bot {
            background-color: var(--chat-bubble-bot);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .chat-bubble-user {
            background-color: var(--chat-bubble-user);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .chat-input-area {
            display: flex;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #000;
        }
        .chat-input-area input {
            flex-grow: 1;
            border: none;
            padding: 8px 0;
            outline: none;
            font-size: 1rem;
            background: transparent;
        }
        .chat-input-area .btn-send {
            background-color: #000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .chat-input-area .btn-send:hover {
            background-color: #333;
        }
        @media (min-width: 992px) {
            .container-custom {
                grid-template-columns: 1fr 1.2fr;
            }
            .chat-section {
                height: 600px;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
    <img src="logo.png" alt="Logo Conecta Saúde">
</div>
        <span class="app-title">Conecta Saúde</span>
    </header>

    <div class="container-custom">
        <div class="medication-section">
            <h4 class="mb-3">Olá <span id="nome-paciente" class="text-primary">Fulano</span>!</h4>
            <p class="mb-4">Aqui está sua bula digital, sempre que der a hora de consumir as medicações enviaremos uma notificação, marque a caixinha correspondente ao remédio sempre que tomá-lo</p>
            
            <div id="lista-remedios">
                </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                Alguma dúvida quanto as medicações? Pergunte sobre elas ao nosso assistente de IA
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="chat-bubble chat-bubble-bot">
                    <i class="bi bi-robot me-1"></i> Olá, alguma dúvida sobre a medicação?
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Digite sua mensagem">
                <button class="btn-send" id="btn-send-message">
                    <i class="bi bi-check-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const nomePacienteSpan = document.getElementById('nome-paciente');
        const listaRemediosDiv = document.getElementById('lista-remedios');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const btnSendMessage = document.getElementById('btn-send-message');

        let currentRemedioContext = null;
        let fullReceitaData = null;

        // --- BANCO DE DADOS DE BULAS (IA) ---
        const bulaData = {
            "dipirona 500mg": {
                "nome": "Dipirona 500mg",
                "para_que_serve": "É um analgésico e antitérmico, usado para aliviar dores e baixar a febre.",
                "efeitos_colaterais": "Os efeitos mais comuns incluem reações alérgicas (vermelhidão, coceira), queda da pressão e, raramente, reações graves no sangue. Náuseas são possíveis.",
                "esqueci_dose": "Tome assim que lembrar, mas não dobre a próxima dose para compensar.",
                "alcool": "Não é recomendado consumir álcool, pois pode intensificar os efeitos colaterais e sobrecarregar o fígado."
            },
            "amoxicilina 250mg": {
                "nome": "Amoxicilina 250mg",
                "para_que_serve": "É um antibiótico usado para tratar infecções bacterianas, como infecções de ouvido, garganta e pele.",
                "efeitos_colaterais": "Pode causar diarreia, náuseas e erupções cutâneas. Reações alérgicas graves são raras, mas requerem atenção imediata.",
                "esqueci_dose": "Tome a dose esquecida assim que lembrar, a menos que esteja muito perto da próxima. Nesse caso, pule a dose esquecida. Nunca tome duas doses.",
                "alcool": "É prudente evitar álcool. Pode aumentar o risco de efeitos colaterais como náuseas e sobrecarregar o fígado."
            },
            "repouso": {
                "nome": "Repouso",
                "para_que_serve": "O repouso é indicado para permitir que seu corpo se recupere de uma condição médica, cirurgia ou lesão.",
                "efeitos_colaterais": "Ficar muito tempo na mesma posição pode causar desconforto. Tente mudar de posição gentilmente, se permitido.",
                "esqueci_dose": "Repouso não é uma 'dose', mas um estado. Tente seguir a orientação médica sobre o nível de atividade permitido.",
                "alcool": "O álcool pode prejudicar a recuperação, interferir no sono e interagir com outros medicamentos. É melhor evitar."
            }
        };

        // --- Função para Renderizar a Lista de Remédios ---
        function renderReceita(data) {
            nomePacienteSpan.innerText = data.paciente;
            listaRemediosDiv.innerHTML = "";

            data.receita.forEach(item => {
                const remedioItemDiv = document.createElement('div');
                remedioItemDiv.className = 'medication-item';
                
                remedioItemDiv.innerHTML = `
                    <input type="radio" id="med-${item.id}" name="medication-select">
                    <label for="med-${item.id}" class="medication-details w-100">
                        <h5>${item.remedio}</h5>
                        <p>${item.posologia}</p>
                        <p class="small text-muted">${item.dias} dias restantes</p>
                    </label>
                `;
                listaRemediosDiv.appendChild(remedioItemDiv);

                remedioItemDiv.addEventListener('click', () => {
                    document.querySelectorAll('.medication-item').forEach(el => el.classList.remove('selected'));
                    remedioItemDiv.classList.add('selected');
                    remedioItemDiv.querySelector('input[type="radio"]').checked = true;

                    currentRemedioContext = item.remedio;
                    displayBotMessage(`Olá! Você selecionou <strong>${item.remedio}</strong>. Como posso ajudar com este medicamento?`);
                });
            });
        }

        // --- Funções do Chat ---
        function displayMessage(text, isUser) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
            bubble.innerHTML = text;
            chatMessagesDiv.appendChild(bubble);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function displayBotMessage(text) {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
            displayMessage(text, false);
        }

        function displayUserMessage(text) {
            displayMessage(text, true);
        }

        function simulateTyping() {
            if (document.getElementById('typing-indicator')) return;
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble chat-bubble-bot';
            typingIndicator.id = 'typing-indicator';
            typingIndicator.innerHTML = '<i class="bi bi-three-dots"></i>';
            chatMessagesDiv.appendChild(typingIndicator);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        btnSendMessage.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            displayUserMessage(messageText);
            chatInput.value = '';
            simulateTyping();

            setTimeout(() => {
                const botResponse = generateBotResponse(messageText, currentRemedioContext);
                displayBotMessage(botResponse);
            }, 1500);
        }

        // --- FUNÇÃO CENTRAL DA "IA" (CORRIGIDA) ---
        function generateBotResponse(userMessage, remedioNome) {
            const userMessageLower = userMessage.toLowerCase();
            
            if (!remedioNome) {
                return "Por favor, clique em um remédio da lista ao lado para que eu possa te ajudar com dúvidas específicas.";
            }

            const remedioKey = remedioNome.toLowerCase();
            const infoBula = bulaData[remedioKey];

            if (!infoBula) {
                return `Desculpe, não tenho informações sobre "${remedioNome}". Por favor, selecione outro remédio.`;
            }

            // --- Lógica da IA (com mais inputs) ---
            if (userMessageLower.includes('efeitos colaterais') || userMessageLower.includes('efeitos') || userMessageLower.includes('mal')) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.efeitos_colaterais}`;
            } 
            if (userMessageLower.includes('esqueci') || (userMessageLower.includes('dose') && userMessageLower.includes('esqueci'))) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.esqueci_dose}`;
            }
            // CORRIGIDO: Adicionado "alcool" sem acento
            if (userMessageLower.includes('álcool') || userMessageLower.includes('alcool') || userMessageLower.includes('beber') || userMessageLower.includes('bebida')) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.alcool}`;
            }
            // CORRIGIDO: Adicionado "funcao" sem acento
            if (userMessageLower.includes('para que serve') || userMessageLower.includes('função') || userMessageLower.includes('funcao') || userMessageLower.includes('uso')) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.para_que_serve}`;
            }
             // CORRIGIDO: Adicionado "duvidas" sem acento
            if (userMessageLower.includes('dúvidas') || userMessageLower.includes('duvidas') || userMessageLower.includes('outras')) {
                if (infoBula.outras_duvidas) {
                    return `Para <strong>${infoBula.nome}</strong>: ${infoBula.outras_duvidas}`;
                } else {
                    return `Não tenho outras dúvidas cadastradas para <strong>${infoBula.nome}</strong>. Tente perguntar algo mais específico, como "efeitos colaterais".`;
                }
            }
            if (userMessageLower.includes('olá') || userMessageLower.includes('oi')) {
                return `Olá! Posso ajudar com <strong>${infoBula.nome}</strong>?`;
            }
            if (userMessageLower.includes('obrigado') || userMessageLower.includes('valeu')) {
                return `De nada! Se tiver mais alguma dúvida, é só perguntar.`;
            }
            // CORRIGIDO: Adicionado "posologia" sem acento
            if (userMessageLower.includes('posologia') || userMessageLower.includes('como tomar')) {
                 if (fullReceitaData && fullReceitaData.receita) {
                    const remedioDaReceita = fullReceitaData.receita.find(r => r.remedio.toLowerCase() === remedioKey);
                    if (remedioDaReceita && remedioDaReceita.posologia) {
                        return `Sua prescrição para <strong>${infoBula.nome}</strong> é: "${remedioDaReceita.posologia}". Siga as orientações do seu médico.`;
                    }
                 }
                 return `A posologia deve ser seguida conforme a orientação do seu médico na receita.`;
            }

            // Resposta padrão
            return `Desculpe, não entendi sua pergunta sobre <strong>${infoBula.nome}</strong>. Tente perguntar sobre "efeitos colaterais", "álcool" ou "para que serve".`;
        }

        // --- Inicialização da Página (COM TRAVA DE SEGURANÇA) ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedReceita = localStorage.getItem('receitaData');
            
            if (storedReceita) {
                // 1. DADOS EXISTEM? OK, continue e mostre a página.
                fullReceitaData = JSON.parse(storedReceita);
                renderReceita(fullReceitaData);
            } else {
                // 2. DADOS NÃO EXISTEM? Redirecione de volta.
                alert("Nenhuma receita foi lida. Por favor, escaneie seu QR Code primeiro.");
                window.location.href = 'index.html'; // Envia o usuário de volta para a tela de scan
            }
        });
    </script>
</body>
</html>