<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conecta Saúde - Sua Receita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --text-color: #343a40;
            --chat-bubble-user: #e2f0fe;
            --chat-bubble-bot: #f1f1f1;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        header {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        header .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #000; /* Preto como no esboço */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
            border: 1px solid #000;
        }
        header .app-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }

        /* Container principal */
        .container-custom {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 15px;
        }

        /* Seção de Medicação */
        .medication-section {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        .medication-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .medication-item:last-child {
            margin-bottom: 0;
        }
        /* Destaque do item selecionado */
        .medication-item.selected {
            background-color: #e2f0fe; /* Azul claro */
        }
        
        /* Checkbox customizado (círculo) */
        .medication-item input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid #333;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            outline: none;
            transition: all 0.2s ease-in-out;
            margin-right: 15px;
            flex-shrink: 0; /* Não encolher */
        }
        .medication-item input[type="radio"]:checked {
            background-color: #000;
            border-color: #000;
            position: relative;
        }
        .medication-item input[type="radio"]:checked::after {
            content: "\f26b"; /* Ícone de check do Bootstrap */
            font-family: "bootstrap-icons";
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }
        .medication-details h5 {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .medication-details p {
            margin-bottom: 0;
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Seção do Chat */
        .chat-section {
            background-color: #fff;
            border: 1px solid #000; /* Borda preta como no esboço */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 500px; /* Altura fixa */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Para o input ficar fixo */
        }
        .chat-header {
            padding: 15px 20px 10px 20px;
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .chat-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.9em;
        }
        .chat-bubble-bot {
            background-color: var(--chat-bubble-bot);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .chat-bubble-user {
            background-color: var(--chat-bubble-user);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        /* Input do Chat como no esboço */
        .chat-input-area {
            display: flex;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #000; /* Linha preta acima do input */
        }
        .chat-input-area input {
            flex-grow: 1;
            border: none; /* Sem borda, como no esboço */
            padding: 8px 0;
            outline: none;
            font-size: 0.9em;
            background: transparent;
        }
        .chat-input-area .btn-send {
            background-color: #000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .chat-input-area .btn-send:hover {
            background-color: #333;
        }

        /* Responsividade (Layout de 2 colunas em telas grandes) */
        @media (min-width: 768px) {
            .container-custom {
                display: grid;
                grid-template-columns: 1fr 1.2fr;
                gap: 20px;
            }
            .medication-section {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">LOGO</div>
        <span class="app-title">Conecta Saúde</span>
    </header>

    <div class="container-custom">
        <div class="medication-section">
            <h4 class="mb-3">Olá <span id="nome-paciente" class="text-primary">Fulano</span>!</h4>
            <p class="mb-4 text-muted small">Aqui está sua bula digital, sempre que der a hora de consumir as medicações enviaremos uma notificação, marque a caixinha correspondente ao remédio sempre que tomá-lo</p>
            
            <div id="lista-remedios">
                </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                Alguma dúvida quanto as medicações? Pergunte sobre elas ao nosso assistente de IA
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="chat-bubble chat-bubble-bot">
                    <i class="bi bi-robot me-1"></i> Olá, alguma dúvida sobre a medicação?
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="digite sua mensagem">
                <button class="btn-send" id="btn-send-message">
                    <i class="bi bi-check-lg"></i> </button>
            </div>
        </div>
    </div>

    <script>
        const nomePacienteSpan = document.getElementById('nome-paciente');
        const listaRemediosDiv = document.getElementById('lista-remedios');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const btnSendMessage = document.getElementById('btn-send-message');

        let currentRemedioContext = null;
        let fullReceitaData = null;

        // --- BANCO DE DADOS DE BULAS (IA) ---
        // Agora com os remédios do seu esboço
        const bulaData = {
            "dipirona": {
                "nome": "Dipirona",
                "para_que_serve": "É um analgésico e antitérmico, usado para aliviar dores e baixar a febre.",
                "efeitos_colaterais": "Os efeitos mais comuns incluem reações alérgicas (vermelhidão, coceira), queda da pressão e, raramente, reações graves no sangue. Náuseas são possíveis.",
                "esqueci_dose": "Tome assim que lembrar, mas não dobre a próxima dose para compensar.",
                "alcool": "Não é recomendado consumir álcool, pois pode intensificar os efeitos colaterais e sobrecarregar o fígado."
            },
            "ibuprofeno": {
                "nome": "Ibuprofeno",
                "para_que_serve": "É um anti-inflamatório não esteroide (AINE) usado para dor, febre e inflamação.",
                "efeitos_colaterais": "Pode causar dor de estômago, náuseas e azia. Em uso prolongado, pode afetar rins ou estômago. Não use se tiver alergia a AINEs.",
                "esqueci_dose": "Tome a dose esquecida assim que lembrar, mas se estiver perto da próxima, pule a esquecida. Não tome duas doses juntas.",
                "alcool": "Evite o consumo de álcool. A mistura aumenta o risco de irritação e sangramento no estômago."
            },
            "clonazepam": {
                "nome": "Clonazepam",
                "para_que_serve": "É um ansiolítico e anticonvulsivante, usado para tratar ansiedade, pânico e epilepsia.",
                "efeitos_colaterais": "Sonolência, tontura, fadiga e dificuldade de coordenação são muito comuns. Pode causar dependência.",
                "esqueci_dose": "Tome assim que lembrar, mas NUNCA dobre a dose. Se esqueceu, consulte seu médico. Não pare de tomar de repente.",
                "alcool": "É **EXTREMAMENTE PERIGOSO** misturar com álcool. A mistura pode causar sonolência grave, parada respiratória, coma e até a morte. **NÃO BEBA ÁLCOOL**."
            }
        };

        // --- Função para Renderizar a Lista de Remédios ---
        function renderReceita(data) {
            nomePacienteSpan.innerText = data.paciente;
            listaRemediosDiv.innerHTML = "";

            data.receita.forEach(item => {
                const remedioItemDiv = document.createElement('div');
                remedioItemDiv.className = 'medication-item';
                // Usamos o 'name' do radio para criar um grupo (só um pode ser selecionado)
                remedioItemDiv.innerHTML = `
                    <input type="radio" id="med-${item.id}" name="medication-select">
                    <label for="med-${item.id}" class="medication-details w-100">
                        <h5>${item.remedio}</h5>
                        <p>${item.posologia}</p>
                        <p class="small text-muted">${item.dias} dias restantes</p>
                    </label>
                `;
                listaRemediosDiv.appendChild(remedioItemDiv);

                // Adiciona o evento de clique para o item
                remedioItemDiv.addEventListener('click', () => {
                    // Remove a classe 'selected' de todos
                    document.querySelectorAll('.medication-item').forEach(el => el.classList.remove('selected'));
                    // Adiciona 'selected' ao item clicado
                    remedioItemDiv.classList.add('selected');

                    // Marca o radio button (já que o clique é no div)
                    remedioItemDiv.querySelector('input[type="radio"]').checked = true;

                    // Define o contexto do chat
                    currentRemedioContext = item.remedio;
                    displayBotMessage(`Olá! Você selecionou <strong>${item.remedio}</strong>. Como posso ajudar com este medicamento?`);
                });
            });
        }

        // --- Funções do Chat ---
        function displayMessage(text, isUser) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
            bubble.innerHTML = text; // innerHTML para renderizar o <strong>
            chatMessagesDiv.appendChild(bubble);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function displayBotMessage(text) {
            // Remove qualquer mensagem anterior "Digitando..."
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
            
            displayMessage(text, false);
        }

        function displayUserMessage(text) {
            displayMessage(text, true);
        }

        function simulateTyping() {
            // Garante que só haja um "Digitando..."
            if (document.getElementById('typing-indicator')) return;
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble chat-bubble-bot';
            typingIndicator.id = 'typing-indicator';
            typingIndicator.innerHTML = '<i class="bi bi-three-dots"></i>'; // "Digitando..."
            chatMessagesDiv.appendChild(typingIndicator);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        btnSendMessage.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            displayUserMessage(messageText);
            chatInput.value = '';
            simulateTyping();

            setTimeout(() => {
                const botResponse = generateBotResponse(messageText, currentRemedioContext);
                displayBotMessage(botResponse);
            }, 1500); // 1.5s de delay
        }

        function generateBotResponse(userMessage, remedioNome) {
            const userMessageLower = userMessage.toLowerCase();
            
            if (!remedioNome) {
                return "Por favor, clique em um remédio da lista ao lado para que eu possa te ajudar com dúvidas específicas.";
            }

            const remedioKey = remedioNome.toLowerCase();
            const infoBula = bulaData[remedioKey];

            if (!infoBula) {
                return `Desculpe, não tenho informações sobre "${remedioNome}". Por favor, selecione outro remédio.`;
            }

            // --- Lógica da IA ---
            if (userMessageLower.includes('efeitos colaterais') || userMessageLower.includes('efeitos') || userMessageLower.includes('mal')) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.efeitos_colaterais}`;
            } 
            if (userMessageLower.includes('esqueci') || (userMessageLower.includes('dose') && userMessageLower.includes('esqueci'))) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.esqueci_dose}`;
            }
            if (userMessageLower.includes('álcool') || userMessageLower.includes('beber') || userMessageLower.includes('bebida')) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.alcool}`;
            }
            if (userMessageLower.includes('para que serve') || userMessageLower.includes('função') || userMessageLower.includes('uso')) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.para_que_serve}`;
            }
            if (userMessageLower.includes('olá') || userMessageLower.includes('oi')) {
                return `Olá! Posso ajudar com <strong>${infoBula.nome}</strong>?`;
            }
            if (userMessageLower.includes('obrigado') || userMessageLower.includes('valeu')) {
                return `De nada! Se tiver mais alguma dúvida, é só perguntar.`;
            }
            if (userMessageLower.includes('posologia') || userMessageLower.includes('como tomar')) {
                 if (fullReceitaData && fullReceitaData.receita) {
                    const remedioDaReceita = fullReceitaData.receita.find(r => r.remedio.toLowerCase() === remedioKey);
                    if (remedioDaReceita && remedioDaReceita.posologia) {
                        return `Sua prescrição para <strong>${infoBula.nome}</strong> é: "${remedioDaReceita.posologia}". Siga as orientações do seu médico.`;
                    }
                 }
                 return `A posologia deve ser seguida conforme a orientação do seu médico na receita.`;
            }

            // Resposta padrão
            return `Desculpe, não entendi sua pergunta sobre <strong>${infoBula.nome}</strong>. Tente perguntar sobre "efeitos colaterais", "álcool" ou "para que serve".`;
        }

        // --- Inicialização da Página ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedReceita = localStorage.getItem('receitaData');
            if (storedReceita) {
                fullReceitaData = JSON.parse(storedReceita);
                renderReceita(fullReceitaData);
            } else {
                // Se não houver dados, exibe um erro
                nomePacienteSpan.innerText = "Visitante";
                listaRemediosDiv.innerHTML = "<p class='text-danger'>Nenhuma receita encontrada. Por favor, escaneie o QR Code na tela inicial.</p>";
            }
        });
    </script>
</body>
</html>