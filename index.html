<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Conecta Sa√∫de</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-light: #f8f9fa;
            --text-color: #343a40;
            --chat-bubble-user: #e2f0fe;
            --chat-bubble-bot: #f1f1f1;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--background-light);
            overflow-x: hidden;
        }

        /* --- CORRE√á√ÉO CHAT (Problema 1) --- */
        /* Todas as 'views' come√ßam escondidas por padr√£o */
        #view-welcome, #view-receita, #view-chat {
            display: none;
        }

        /* Classes de anima√ß√£o */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-effect {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .chat-bubble {
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-bubble-bot {
            background-color: var(--chat-bubble-bot);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .chat-bubble-user {
            background-color: var(--chat-bubble-user);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .chat-input-area {
            position: sticky;
            bottom: 0;
            background-color: #ffffff;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
        }

        /* --- CORRE√á√ÉO C√ÇMERA (Problema 2) --- */
        #qr-reader {
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            overflow: hidden;
            min-height: 250px; /* Garante a altura da caixa */
            background: #eee;
        }
        /* Esta √© a regra m√°gica que faltava */
        #qr-reader video {
            width: 100% !important; /* For√ßa o v√≠deo a preencher a caixa */
            height: auto !important;
            object-fit: cover; /* Cobre a √°rea sem distorcer */
        }
        #qr-reader__dashboard {
            display: none !important;
        }
        
        /* Layout de header */
        header {
            background-color: #fff;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1020;
        }
        header .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
        }
        header .app-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }

        /* Rem√©dio Item */
        .remedio-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #fff;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-color);
            text-decoration: none;
        }
        .remedio-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            background-color: #f0f8ff;
        }
        .remedio-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
        }
        .remedio-item .bi-question-circle-fill {
            font-size: 1.8em;
            color: var(--secondary-color);
        }

    </style>
</head>
<body class="bg-light">

    <header>
        <div class="d-flex align-items-center">
            <div class="logo">CS</div>
            <span class="app-title">Conecta Sa√∫de</span>
        </div>
    </header>

    <div id="view-welcome" class="container text-center p-4 vh-100 d-flex flex-column justify-content-center fade-in">
        <h1 class="display-5 fw-bold mb-4">Cuidando da sua recupera√ß√£o em casa.</h1>
        <p class="lead mb-4">Aponte a c√¢mera para o QR Code da sua receita de alta para come√ßar.</p>
        <button id="btn-start-scan" class="btn btn-primary btn-lg pulse-effect">
            <i class="bi bi-qr-code-scan me-2"></i> Escanear QR Code
        </button>
        
        <div id="qr-reader" class="mt-4" style="display: none;"></div>
        <p id="scan-feedback" class="text-muted small mt-3" style="display: none;">Centralizando o QR Code...</p>
    </div>

    <div id="view-receita" class="container p-3 fade-in">
        <h2 class="mb-3">Ol√°, <span id="nome-paciente" class="text-primary"></span>!</h2>
        <p class="text-muted">Sua prescri√ß√£o est√° pronta. Marque os itens conclu√≠dos e toque para tirar d√∫vidas.</p>
        
        <div id="lista-remedios" class="d-flex flex-column gap-2">
            </div>

        <div class="d-grid gap-2 mt-4">
            <button id="btn-panico" class="btn btn-danger btn-lg">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> N√£o estou me sentindo bem
            </button>
        </div>
    </div>

    <div id="view-chat" class="container d-flex flex-column vh-100 p-0 fade-in">
        <div class="d-flex align-items-center p-3 border-bottom bg-white sticky-top">
            <button id="btn-chat-voltar" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i>
            </button>
            <h5 class="m-0">BulaBot Assistente</h5>
        </div>
        
        <div class="chat-container flex-grow-1">
            </div>

        <div class="chat-input-area p-3 bg-white">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control rounded-pill" placeholder="Pergunte sobre o rem√©dio..." aria-label="Pergunte sobre o rem√©dio...">
                <button class="btn btn-primary rounded-pill ms-2" type="button" id="btn-send-message">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
            <div id="chat-sugestoes" class="d-flex flex-wrap gap-2 mt-2 justify-content-center">
                 <button class="btn btn-sm btn-outline-primary" onclick="enviarPerguntaSugestao('Quais os efeitos colaterais?')">Efeitos?</button>
                 <button class="btn btn-sm btn-outline-primary" onclick="enviarPerguntaSugestao('Esqueci uma dose.')">Esqueci dose?</button>
                 <button class="btn btn-sm btn-outline-primary" onclick="enviarPerguntaSugestao('Posso beber?')">Beber √°lcool?</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
    // --- SE√á√ÉO DE REFER√äNCIAS DA DOM ---
    const viewWelcome = document.getElementById('view-welcome');
    const viewReceita = document.getElementById('view-receita');
    const viewChat = document.getElementById('view-chat');
    
    const btnStartScan = document.getElementById('btn-start-scan');
    const qrReaderDiv = document.getElementById('qr-reader');
    const scanFeedback = document.getElementById('scan-feedback');
    
    const listaRemedios = document.getElementById('lista-remedios');
    const nomePaciente = document.getElementById('nome-paciente');
    const btnPanico = document.getElementById('btn-panico');

    const btnChatVoltar = document.getElementById('btn-chat-voltar');
    const chatContainer = document.querySelector('#view-chat .chat-container');
    const chatInput = document.getElementById('chat-input');
    const btnSendMessage = document.getElementById('btn-send-message');
    // 'typingIndicator' ser√° criado dinamicamente

    const html5QrCode = new Html5Qrcode("qr-reader");

    let currentRemedioContext = null;
    let fullReceitaData = null;

    // --- BANCO DE DADOS DE BULAS (CONHECIMENTO EST√ÅTICO) ---
    const bulaData = {
        "dipirona 500mg": {
            "nome": "Dipirona 500mg",
            "para_que_serve": "√â um analg√©sico e antit√©rmico, usado para aliviar dores e baixar a febre.",
            "efeitos_colaterais": "Os efeitos mais comuns incluem rea√ß√µes al√©rgicas (vermelhid√£o na pele, coceira, incha√ßo), queda da press√£o arterial (hipotens√£o) e, raramente, agranulocitose (diminui√ß√£o grave de gl√≥bulos brancos). N√°useas e v√¥mitos s√£o poss√≠veis, mas menos comuns.",
            "esqueci_dose": "Se esquecer uma dose e for uma dose √∫nica para dor/febre, tome assim que lembrar. Se for um tratamento cont√≠nuo, siga a orienta√ß√£o m√©dica e evite dobrar a dose. Em caso de d√∫vida, pergunte ao seu m√©dico.",
            "alcool": "N√£o √© recomendado consumir √°lcool, pois pode intensificar os efeitos colaterais e sobrecarregar o f√≠gado.",
            "outras_duvidas": "Pode causar colora√ß√£o avermelhada na urina (inofensivo). Evitar em casos de alergia a pirazolonas ou doen√ßas da medula √≥ssea."
        },
        "amoxicilina 250mg": {
            "nome": "Amoxicilina 250mg",
            "para_que_serve": "√â um antibi√≥tico usado para tratar infec√ß√µes bacterianas, como infec√ß√µes de ouvido, garganta, pele e trato urin√°rio.",
            "efeitos_colaterais": "Os efeitos comuns incluem diarreia, n√°useas, v√¥mitos e erup√ß√µes cut√¢neas. Rea√ß√µes al√©rgicas mais graves (incha√ßo no rosto, dificuldade para respirar) s√£o raras, mas requerem aten√ß√£o m√©dica imediata.",
            "esqueci_dose": "Tome a dose esquecida assim que lembrar, a menos que esteja muito pr√≥ximo da pr√≥xima dose (menos de 2 horas). Nesse caso, pule a dose esquecida e continue o esquema normalmente. Nunca tome duas doses para compensar.",
            "alcool": "O consumo de √°lcool durante o tratamento com Amoxicilina n√£o √© diretamente contraindicado, mas pode aumentar a ocorr√™ncia de efeitos gastrointestinais como n√°useas e diarreia, al√©m de sobrecarregar o f√≠gado. √â prudente evitar.",
            "outras_duvidas": "√â importante completar todo o curso do tratamento, mesmo que se sinta melhor, para evitar a resist√™ncia bacteriana."
        },
        "repouso": {
            "nome": "Repouso",
            "para_que_serve": "O repouso √© indicado para permitir que seu corpo se recupere de uma condi√ß√£o m√©dica, cirurgia ou les√£o. Ajuda a reduzir o estresse f√≠sico e mental.",
            "efeitos_colaterais": "Ficar muito tempo na mesma posi√ß√£o pode causar desconforto. Tente mudar de posi√ß√£o gentilmente, se permitido.",
            "esqueci_dose": "Repouso n√£o √© uma 'dose', mas um estado. Tente seguir a orienta√ß√£o m√©dica sobre o n√≠vel de atividade permitido. Se voc√™ se esfor√ßou demais, tente descansar mais no pr√≥ximo per√≠odo.",
            "alcool": "O √°lcool pode prejudicar a recupera√ß√£o, interferir no sono e interagir com outros medicamentos. √â melhor evitar.",
            "outras_duvidas": "Siga as orienta√ß√µes espec√≠ficas do seu m√©dico sobre quanto tempo de repouso √© necess√°rio e quando voc√™ pode retomar as atividades normais."
        }
    };

    // --- SE√á√ÉO DE NAVEGA√á√ÉO ENTRE TELAS ---
    // O JS agora s√≥ controla o 'display'. As classes de layout est√£o no HTML.
    function mostrarTela(telaId) {
        // Esconde todas as telas
        [viewWelcome, viewReceita, viewChat].forEach(v => {
            v.style.display = 'none';
        });
        
        // Mostra a tela alvo
        const targetView = document.getElementById(telaId);
        
        // O HTML j√° tem as classes 'd-flex', etc.
        // O JS s√≥ precisa mudar o 'display' de 'none' para 'block' ou 'flex'
        if (telaId === 'view-chat' || telaId === 'view-welcome') {
            targetView.style.display = 'flex'; // 'flex' √© a propriedade correta para essas telas
        } else {
            targetView.style.display = 'block'; // 'block' para a 'view-receita'
        }
        
        targetView.classList.add('fade-in');
        setTimeout(() => targetView.classList.remove('fade-in'), 500);
    }

    // --- SE√á√ÉO DO LEITOR DE QR CODE ---
    function onScanSuccess(decodedText, decodedResult) {
        scanFeedback.innerText = "Sucesso! Processando...";
        scanFeedback.className = "text-success fw-bold";
        
        html5QrCode.stop().then(() => {
            try {
                fullReceitaData = JSON.parse(decodedText);
                renderReceita(fullReceitaData);
                mostrarTela('view-receita');
            } catch (error) {
                console.error("FALHA AO PROCESSAR O JSON!", error);
                scanFeedback.innerText = "Erro: Este QR Code n√£o √© uma receita v√°lida.";
                scanFeedback.className = "text-danger fw-bold";
                btnStartScan.style.display = 'block';
                qrReaderDiv.style.display = 'none';
                scanFeedback.style.display = 'block'; 
            }
        }).catch(err => {
            console.warn("Erro ao parar a c√¢mera, mas seguimos em frente.", err);
            try {
                fullReceitaData = JSON.parse(decodedText);
                renderReceita(fullReceitaData);
                mostrarTela('view-receita');
            } catch (error) {
                console.error("FALHA AO PROCESSAR O JSON!", error);
                scanFeedback.innerText = "Erro: Este QR Code n√£o √© uma receita v√°lida.";
                scanFeedback.className = "text-danger fw-bold";
                btnStartScan.style.display = 'block';
                qrReaderDiv.style.display = 'none';
                scanFeedback.style.display = 'block'; 
            }
        });
    }

    function onScanFailure(error) { /* n√£o faz nada */ }

    btnStartScan.addEventListener('click', () => {
        qrReaderDiv.style.display = 'block'; // Mostra a caixa da c√¢mera
        scanFeedback.style.display = 'block';
        scanFeedback.innerText = "Centralizando o QR Code...";
        scanFeedback.className = "text-muted small mt-2";
        btnStartScan.style.display = 'none';

        // Inicia a c√¢mera
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            console.error("Erro ao iniciar a c√¢mera:", err);
            alert("N√£o foi poss√≠vel acessar a c√¢mera. Voc√™ deu permiss√£o no navegador?");
            btnStartScan.style.display = 'block';
            qrReaderDiv.style.display = 'none';
            scanFeedback.style.display = 'none';
        });
    });


    // --- SE√á√ÉO DA TELA DE RECEITA ---
    function renderReceita(data) {
        nomePaciente.innerText = data.paciente;
        listaRemedios.innerHTML = "";
        
        data.receita.forEach(item => {
            const remedioDiv = document.createElement('div');
            remedioDiv.className = 'remedio-item';

            const checkboxId = `remedio-${item.id}`;
            remedioDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <input class="form-check-input me-3" type="checkbox" value="" id="${checkboxId}">
                    <div>
                        <h5 class="mb-0">${item.remedio}</h5>
                        <p class="text-muted mb-0 small">${item.posologia}</p>
                        <small class="text-secondary">Por ${item.dias} dias.</small>
                    </div>
                </div>
                <button class="btn btn-link p-0 text-decoration-none" data-remedio-nome="${item.remedio}">
                    <i class="bi bi-question-circle-fill"></i>
                </button>
            `;
            
            remedioDiv.querySelector('button').addEventListener('click', (e) => {
                e.preventDefault();
                currentRemedioContext = item.remedio;
                abrirChat(item.remedio);
            });

            listaRemedios.appendChild(remedioDiv);
        });
    }
    
    btnPanico.addEventListener('click', () => {
        alert('ALERTA ENVIADO! üö®\n\nSua solicita√ß√£o foi enviada √† central de enfermagem. Em breve, um profissional de sa√∫de entrar√° em contato.');
    });

    // --- SE√á√ÉO DO BULABOT (CHAT) ---
    btnChatVoltar.addEventListener('click', () => {
        mostrarTela('view-receita');
    });

    function abrirChat(nomeDoRemedio) {
        currentRemedioContext = nomeDoRemedio;
        chatContainer.innerHTML = ''; // Limpa o chat
        
        // Adiciona a sauda√ß√£o inicial do bot
        const initialBotGreeting = document.createElement('div');
        initialBotGreeting.className = 'chat-bubble chat-bubble-bot fade-in';
        initialBotGreeting.innerHTML = `Ol√°! Sou o BulaBot. Estou aqui para tirar suas d√∫vidas sobre: <strong>${nomeDoRemedio}</strong>. Como posso ajudar?`;
        chatContainer.appendChild(initialBotGreeting);

        // Adiciona o 'typingIndicator' (escondido)
        const typingIndicatorHTML = document.createElement('div');
        typingIndicatorHTML.id = 'typing-indicator'; // Damos um ID para o JS
        typingIndicatorHTML.className = 'chat-bubble chat-bubble-bot';
        typingIndicatorHTML.style.display = 'none';
        typingIndicatorHTML.textContent = 'Digitando...';
        chatContainer.appendChild(typingIndicatorHTML);
        
        mostrarTela('view-chat');
        chatInput.focus();
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Simula o envio de mensagem
    btnSendMessage.addEventListener('click', () => {
        enviarPergunta(chatInput.value);
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            enviarPergunta(chatInput.value);
        }
    });

    function enviarPergunta(pergunta) {
        if (pergunta.trim() === '') return;

        const userBubble = document.createElement('div');
        userBubble.className = 'chat-bubble chat-bubble-user fade-in';
        userBubble.textContent = pergunta;
        chatContainer.appendChild(userBubble);
        chatInput.value = '';
        chatContainer.scrollTop = chatContainer.scrollHeight;

        const localTypingIndicator = document.getElementById('typing-indicator');
        if (localTypingIndicator) localTypingIndicator.style.display = 'block';
        chatContainer.scrollTop = chatContainer.scrollHeight;

        setTimeout(() => {
            if (localTypingIndicator) localTypingIndicator.style.display = 'none';
            const botResponseBubble = document.createElement('div');
            botResponseBubble.className = 'chat-bubble chat-bubble-bot fade-in';
            botResponseBubble.innerHTML = gerarRespostaIA(pergunta, currentRemedioContext);
            chatContainer.appendChild(botResponseBubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 1500);
    }

    // --- FUN√á√ÉO CENTRAL DA "IA" ---
    function gerarRespostaIA(pergunta, remedioNomeCompleto) {
        const perguntaLower = pergunta.toLowerCase();
        const remedioKey = remedioNomeCompleto.toLowerCase();
        const infoBula = bulaData[remedioKey];

        if (!infoBula) {
            const chavesBula = Object.keys(bulaData);
            const chaveEncontrada = chavesBula.find(chave => remedioKey.includes(chave.split(' ')[0]));
            const infoBulaParcial = bulaData[chaveEncontrada];

            if (infoBulaParcial) {
                return gerarRespostaIA(pergunta, infoBulaParcial.nome);
            }
            return `Desculpe, n√£o encontrei informa√ß√µes detalhadas sobre "${remedioNomeCompleto}" no meu banco de dados. Para d√∫vidas espec√≠ficas, consulte um profissional de sa√∫de.`;
        }

        if (perguntaLower.includes('efeitos colaterais') || perguntaLower.includes('efeitos') || perguntaLower.includes('mal')) {
            return `Para <strong>${infoBula.nome}</strong>: ${infoBula.efeitos_colaterais}`;
        } 
        if (perguntaLower.includes('esqueci') || (perguntaLower.includes('dose') && perguntaLower.includes('esqueci'))) {
            return `Para <strong>${infoBula.nome}</strong>: ${infoBula.esqueci_dose}`;
        }
        if (perguntaLower.includes('√°lcool') || perguntaLower.includes('beber') || perguntaLower.includes('bebida')) {
            return `Para <strong>${infoBula.nome}</strong>: ${infoBula.alcool}`;
        }
        if (perguntaLower.includes('para que serve') || perguntaLower.includes('fun√ß√£o') || perguntaLower.includes('uso')) {
            return `Para <strong>${infoBula.nome}</strong>: ${infoBula.para_que_serve}`;
        }
        if (perguntaLower.includes('d√∫vidas') || perguntaLower.includes('outras')) {
            if (infoBula.outras_duvidas) {
                return `Para <strong>${infoBula.nome}</strong>: ${infoBula.outras_duvidas}`;
            }
        }
        
        if (perguntaLower.includes('ol√°') || perguntaLower.includes('oi')) {
            return `Ol√°! Como posso te ajudar hoje sobre <strong>${infoBula.nome}</strong>?`;
        }
        if (perguntaLower.includes('obrigado') || perguntaLower.includes('valeu')) {
            return `De nada! Se tiver mais alguma d√∫vida sobre <strong>${infoBula.nome}</strong>, √© s√≥ perguntar.`;
        }
        if (perguntaLower.includes('como devo tomar') || perguntaLower.includes('posologia')) {
             if (fullReceitaData && fullReceitaData.receita) {
                const remedioDaReceita = fullReceitaData.receita.find(r => r.remedio.toLowerCase() === remedioKey);
                if (remedioDaReceita && remedioDaReceita.posologia) {
                    return `Sua prescri√ß√£o para <strong>${infoBula.nome}</strong> √©: "${remedioDaReceita.posologia}". Siga as orienta√ß√µes do seu m√©dico.`;
                }
             }
             return `Para <strong>${infoBula.nome}</strong>, a posologia deve ser seguida conforme a orienta√ß√£o do seu m√©dico na receita. Verifique o seu cart√£o de alta.`;
        }

        return `Desculpe, n√£o entendi sua pergunta sobre <strong>${infoBula.nome}</strong>. Poderia tentar reformular ou fazer uma pergunta mais espec√≠fica sobre os <strong>efeitos colaterais</strong>, <strong>esquecer uma dose</strong>, <strong>√°lcool</strong> ou <strong>para que serve</strong>?`;
    }

    function enviarPerguntaSugestao(pergunta) {
        enviarPergunta(pergunta);
    }

    // Inicia a tela de boas-vindas
    document.addEventListener('DOMContentLoaded', () => {
        mostrarTela('view-welcome');
    });
    </script>
</body>
</html>