<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Conecta Saﾃｺde</title>
    <style>
        :root {
            --primary-color: #007bff; /* Azul padrﾃ｣o do Bootstrap */
            --secondary-color: #6c757d; /* Cinza */
            --background-light: #f8f9fa; /* Fundo claro */
            --text-color: #343a40; /* Texto escuro */
            --chat-bubble-user: #e2f0fe; /* Azul claro para o usuﾃ｡rio */
            --chat-bubble-bot: #f1f1f1; /* Cinza claro para o bot */
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--background-light);
            overflow-x: hidden; /* Evita scroll horizontal em transiﾃｧﾃｵes */
        }

        /* Classes de animaﾃｧﾃ｣o */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-effect {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .chat-bubble {
            padding: 12px 18px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
            word-wrap: break-word; /* Garante que o texto quebre */
        }
        .chat-bubble-bot {
            background-color: var(--chat-bubble-bot);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .chat-bubble-user {
            background-color: var(--chat-bubble-user);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-container {
            max-height: calc(100vh - 200px); /* Altura fixa para o chat */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding-bottom: 10px; /* Espaﾃｧo para o input */
        }
        .chat-input-area {
            position: sticky;
            bottom: 0;
            background-color: var(--background-light);
            padding: 10px 0;
            border-top: 1px solid #dee2e6;
        }

        /* Ajustes para o QR Reader */
        #qr-reader {
            max-width: 300px; /* Tamanho mais amigﾃ｡vel em mobile */
            margin-left: auto;
            margin-right: auto;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            overflow: hidden; /* Para garantir que o vﾃｭdeo nﾃ｣o escape */
        }
        #qr-reader__dashboard {
            display: none !important; /* Esconde o painel de controle do html5-qrcode */
        }
        
        /* Layout de header */
        header {
            background-color: #fff;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
        }
        header .app-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }

        /* Remﾃｩdio Item */
        .remedio-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #fff;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-color);
            text-decoration: none;
        }
        .remedio-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            background-color: #f0f8ff; /* Leve azul ao passar o mouse */
        }
        .remedio-item input[type="checkbox"] {
            transform: scale(1.5); /* Checkbox maior */
            margin-right: 15px;
        }
        .remedio-item .bi-check-circle-fill {
            color: var(--primary-color);
            font-size: 1.8em;
        }
        .remedio-item .bi-question-circle-fill {
            font-size: 1.8em;
            color: var(--secondary-color);
        }
    </style>
</head>
<body class="bg-light">

    <header>
        <div class="d-flex align-items-center">
            <div class="logo">CS</div>
            <span class="app-title">Conecta Saﾃｺde</span>
        </div>
        </header>

    <div id="view-welcome" class="container text-center p-4 vh-100 d-flex flex-column justify-content-center fade-in">
        <h1 class="display-5 fw-bold mb-4">Cuidando da sua recuperaﾃｧﾃ｣o em casa.</h1>
        <p class="lead mb-4">Aponte a cﾃ｢mera para o QR Code da sua receita de alta para comeﾃｧar.</p>
        <button id="btn-start-scan" class="btn btn-primary btn-lg pulse-effect">
            <i class="bi bi-qr-code-scan me-2"></i> Escanear QR Code
        </button>
        
        <div id="qr-reader" class="mt-4" style="display: none;"></div>
        <p id="scan-feedback" class="text-muted small mt-3" style="display: none;">Centralizando o QR Code...</p>
    </div>

    <div id="view-receita" class="container p-3 fade-in" style="display: none;">
        <h2 class="mb-3">Olﾃ｡, <span id="nome-paciente" class="text-primary"></span>!</h2>
        <p class="text-muted">Sua prescriﾃｧﾃ｣o estﾃ｡ pronta. Marque os itens concluﾃｭdos e toque para tirar dﾃｺvidas.</p>
        
        <div id="lista-remedios" class="d-flex flex-column gap-2">
            </div>

        <div class="d-grid gap-2 mt-4">
            <button id="btn-panico" class="btn btn-danger btn-lg">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> Nﾃ｣o estou me sentindo bem
            </button>
        </div>
    </div>

    <div id="view-chat" class="container d-flex flex-column vh-100 p-0 fade-in" style="display: none;">
        <div class="d-flex align-items-center p-3 border-bottom bg-white sticky-top">
            <button id="btn-chat-voltar" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i>
            </button>
            <h5 class="m-0">BulaBot Assistente</h5>
        </div>
        
        <div class="chat-container p-3 flex-grow-1">
            <div class="chat-bubble chat-bubble-bot">
                Olﾃ｡! Sou seu assistente para dﾃｺvidas sobre: <strong id="chat-remedio-nome" class="text-primary"></strong>. Como posso ajudar?
            </div>
            
            <div id="chat-predefined-responses" class="mt-2">
                <div id="resp-efeitos" class="chat-bubble chat-bubble-bot" style="display: none;">
                    <strong>Efeitos Colaterais:</strong><br>
                    Os efeitos mais comuns para este medicamento incluem reaﾃｧﾃｵes alﾃｩrgicas, queda da pressﾃ｣o e, raramente, reaﾃｧﾃｵes na pele. Nﾃ｡useas sﾃ｣o possﾃｭveis. Se sentir algo grave, por favor, utilize o botﾃ｣o "Nﾃ｣o estou me sentindo bem" na tela anterior.
                </div>
                 <div id="resp-esqueci" class="chat-bubble chat-bubble-bot" style="display: none;">
                    <strong>Esqueci uma dose:</strong><br>
                    Tome a dose assim que lembrar. No entanto, se estiver quase na hora da prﾃｳxima dose, pule a dose esquecida e volte ao seu horﾃ｡rio regular. Nﾃ｣o tome duas doses ao mesmo tempo.
                </div>
                 <div id="resp-posso_beber" class="chat-bubble chat-bubble-bot" style="display: none;">
                    <strong>Sobre ﾃ〕cool:</strong><br>
                    Para a maioria dos medicamentos, nﾃ｣o ﾃｩ recomendado o consumo de ﾃ｡lcool, pois pode aumentar o risco de efeitos colaterais e sobrecarregar o fﾃｭgado. Consulte sempre seu mﾃｩdico.
                </div>
                <div id="resp-generica" class="chat-bubble chat-bubble-bot" style="display: none;">
                    Desculpe, nﾃ｣o entendi sua pergunta. Poderia reformular? Ou selecione uma das opﾃｧﾃｵes abaixo.
                </div>
            </div>

            <div id="typing-indicator" class="chat-bubble chat-bubble-bot" style="display: none;">
                Digitando...
            </div>
        </div>

        <div class="chat-input-area p-3 bg-white">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control rounded-pill" placeholder="Pergunte sobre o remﾃｩdio..." aria-label="Pergunte sobre o remﾃｩdio...">
                <button class="btn btn-primary rounded-pill ms-2" type="button" id="btn-send-message">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
            <div id="chat-sugestoes" class="d-flex flex-wrap gap-2 mt-2 justify-content-center">
                 <button class="btn btn-sm btn-outline-primary" onclick="enviarPerguntaSugestao('Quais os efeitos colaterais?')">Efeitos?</button>
                 <button class="btn btn-sm btn-outline-primary" onclick="enviarPerguntaSugestao('Esqueci uma dose.')">Esqueci dose?</button>
                 <button class="btn btn-sm btn-outline-primary" onclick="enviarPerguntaSugestao('Posso beber?')">Beber ﾃ｡lcool?</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
        // --- SEﾃﾃグ DE REFERﾃ劾CIAS DA DOM ---
        const viewWelcome = document.getElementById('view-welcome');
        const viewReceita = document.getElementById('view-receita');
        const viewChat = document.getElementById('view-chat');
        
        const btnStartScan = document.getElementById('btn-start-scan');
        const qrReaderDiv = document.getElementById('qr-reader');
        const scanFeedback = document.getElementById('scan-feedback');
        
        const listaRemedios = document.getElementById('lista-remedios');
        const nomePaciente = document.getElementById('nome-paciente');
        const btnPanico = document.getElementById('btn-panico');

        const btnChatVoltar = document.getElementById('btn-chat-voltar');
        const chatRemedioNome = document.getElementById('chat-remedio-nome');
        const chatRemedioNome2 = document.getElementById('chat-remedio-nome-2'); // Para o balﾃ｣o inicial do bot
        const chatContainer = document.querySelector('#view-chat .chat-container'); // Onde as msgs vﾃ｣o
        const chatInput = document.getElementById('chat-input');
        const btnSendMessage = document.getElementById('btn-send-message');
        const chatPredefinedResponses = document.getElementById('chat-predefined-responses');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatSugestoes = document.getElementById('chat-sugestoes'); // Botﾃｵes de sugestﾃ｣o

        const html5QrCode = new Html5Qrcode("qr-reader");

        let currentRemedioContext = null; // Guarda o remﾃｩdio que estﾃ｡ sendo discutido

        // --- SEﾃﾃグ DE NAVEGAﾃﾃグ ENTRE TELAS ---
        function mostrarTela(telaId) {
            // Esconde todas as telas
            [viewWelcome, viewReceita, viewChat].forEach(v => v.style.display = 'none');
            // Mostra a tela desejada e adiciona animaﾃｧﾃ｣o
            const targetView = document.getElementById(telaId);
            targetView.style.display = 'flex'; // Usar flex para vh-100 em chat
            targetView.classList.add('fade-in');
            setTimeout(() => targetView.classList.remove('fade-in'), 500); // Remove apﾃｳs a animaﾃｧﾃ｣o
        }

        // --- SEﾃﾃグ DO LEITOR DE QR CODE ---
        function onScanSuccess(decodedText, decodedResult) {
            scanFeedback.innerText = "Sucesso! Processando...";
            scanFeedback.className = "text-success fw-bold";
            
            html5QrCode.stop().then(() => {
                try {
                    const data = JSON.parse(decodedText);
                    renderReceita(data);
                    mostrarTela('view-receita');
                } catch (error) {
                    console.error("FALHA AO PROCESSAR O JSON!", error);
                    scanFeedback.innerText = "Erro: Este QR Code nﾃ｣o ﾃｩ uma receita vﾃ｡lida.";
                    scanFeedback.className = "text-danger fw-bold";
                    
                    btnStartScan.style.display = 'block';
                    qrReaderDiv.style.display = 'none';
                    scanFeedback.style.display = 'block'; 
                }
            }).catch(err => {
                console.warn("Erro ao parar a cﾃ｢mera, mas seguimos em frente.", err);
                // Tenta processar mesmo se parar a cﾃ｢mera falhar
                try {
                    const data = JSON.parse(decodedText);
                    renderReceita(data);
                    mostrarTela('view-receita');
                } catch (error) {
                    console.error("FALHA AO PROCESSAR O JSON (apﾃｳs erro de parada de cﾃ｢mera)!", error);
                    scanFeedback.innerText = "Erro: Este QR Code nﾃ｣o ﾃｩ uma receita vﾃ｡lida.";
                    scanFeedback.className = "text-danger fw-bold";
                    btnStartScan.style.display = 'block';
                    qrReaderDiv.style.display = 'none';
                    scanFeedback.style.display = 'block'; 
                }
            });
        }

        function onScanFailure(error) { /* console.warn(`Scan de QR code falhou: ${error}`); */ }

        btnStartScan.addEventListener('click', () => {
            qrReaderDiv.style.display = 'block';
            scanFeedback.style.display = 'block';
            scanFeedback.innerText = "Centralizando o QR Code...";
            scanFeedback.className = "text-muted small mt-2";
            btnStartScan.style.display = 'none';

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Erro ao iniciar a cﾃ｢mera:", err);
                alert("Nﾃ｣o foi possﾃｭvel acessar a cﾃ｢mera. Por favor, verifique as permissﾃｵes do navegador.");
                btnStartScan.style.display = 'block';
                qrReaderDiv.style.display = 'none';
                scanFeedback.style.display = 'none';
            });
        });


        // --- SEﾃﾃグ DA TELA DE RECEITA ---
        function renderReceita(data) {
            nomePaciente.innerText = data.paciente;
            listaRemedios.innerHTML = "";
            
            data.receita.forEach(item => {
                const remedioDiv = document.createElement('div');
                remedioDiv.className = 'remedio-item'; // Use a nova classe

                const checkboxId = `remedio-${item.id}`;
                remedioDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <input class="form-check-input me-3" type="checkbox" value="" id="${checkboxId}">
                        <div>
                            <h5 class="mb-0">${item.remedio}</h5>
                            <p class="text-muted mb-0 small">${item.posologia}</p>
                            <small class="text-secondary">Por ${item.dias} dias.</small>
                        </div>
                    </div>
                    <button class="btn btn-link p-0 text-decoration-none" data-remedio-nome="${item.remedio}">
                        <i class="bi bi-question-circle-fill"></i>
                    </button>
                `;
                
                // Adiciona listener ao botﾃ｣o de dﾃｺvida, nﾃ｣o ao card todo
                remedioDiv.querySelector('button').addEventListener('click', (e) => {
                    e.preventDefault();
                    currentRemedioContext = item.remedio; // Define o contexto
                    abrirChat(item.remedio);
                });

                listaRemedios.appendChild(remedioDiv);
            });
        }
        
        btnPanico.addEventListener('click', () => {
            alert('ALERTA ENVIADO! 圷\n\nSua solicitaﾃｧﾃ｣o foi enviada ﾃ central de enfermagem. Em breve, um profissional de saﾃｺde entrarﾃ｡ em contato.');
        });

        // --- SEﾃﾃグ DO BULABOT (CHAT) ---
        btnChatVoltar.addEventListener('click', () => {
            mostrarTela('view-receita');
        });

        function abrirChat(nomeDoRemedio) {
            currentRemedioContext = nomeDoRemedio; // Garante que o contexto esteja certo
            chatRemedioNome.innerText = nomeDoRemedio;
            chatRemedioNome2.innerText = nomeDoRemedio;
            
            // Limpa mensagens anteriores (exceto a primeira do bot)
            const oldMessages = chatContainer.querySelectorAll('.chat-bubble:not(:first-child)');
            oldMessages.forEach(msg => msg.remove());
            chatPredefinedResponses.style.display = 'none'; // Esconde as respostas prﾃｩ-definidas iniciais

            mostrarTela('view-chat');
            chatInput.focus(); // Foca no input para o usuﾃ｡rio digitar
            chatContainer.scrollTop = chatContainer.scrollHeight; // Rola para o final do chat
        }

        // Simula o envio de mensagem
        btnSendMessage.addEventListener('click', () => {
            enviarPergunta(chatInput.value);
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                enviarPergunta(chatInput.value);
            }
        });

        function enviarPergunta(pergunta) {
            if (pergunta.trim() === '') return;

            // Adiciona a mensagem do usuﾃ｡rio
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble chat-bubble-user fade-in';
            userBubble.textContent = pergunta;
            chatContainer.appendChild(userBubble);
            chatInput.value = ''; // Limpa o input
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Simula a "digitaﾃｧﾃ｣o" da IA
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            setTimeout(() => {
                typingIndicator.style.display = 'none';
                // Adiciona a resposta da IA (simulada)
                const botResponseBubble = document.createElement('div');
                botResponseBubble.className = 'chat-bubble chat-bubble-bot fade-in';
                botResponseBubble.innerHTML = gerarRespostaIA(pergunta, currentRemedioContext);
                chatContainer.appendChild(botResponseBubble);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1500); // Espera 1.5s para "responder"
        }

        // Funﾃｧﾃ｣o para simular a IA com respostas contextuais
        function gerarRespostaIA(pergunta, remedio) {
            const perguntaLower = pergunta.toLowerCase();

            if (perguntaLower.includes('efeitos colaterais') || perguntaLower.includes('efeitos') || perguntaLower.includes('mal')) {
                // Aqui vocﾃｪ pode fazer IFs mais especﾃｭficos por remﾃｩdio, se quiser
                if (remedio.toLowerCase().includes('dipirona')) {
                    return `Para **${remedio}**: Os efeitos mais comuns incluem reaﾃｧﾃｵes alﾃｩrgicas, queda da pressﾃ｣o e, raramente, reaﾃｧﾃｵes na pele. Nﾃ｡useas sﾃ｣o possﾃｭveis. Se sentir algo grave, por favor, utilize o botﾃ｣o "Nﾃ｣o estou me sentindo bem" na tela anterior.`;
                }
                return `Para **${remedio}**: Os efeitos colaterais comuns podem incluir nﾃ｡useas, tontura e dor de cabeﾃｧa. Consulte a bula para a lista completa ou um profissional de saﾃｺde para detalhes especﾃｭficos ao seu caso.`;
            } else if (perguntaLower.includes('esqueci') || perguntaLower.includes('dose') && perguntaLower.includes('esqueci')) {
                return `Para **${remedio}**: Se vocﾃｪ esqueceu uma dose, tome-a assim que lembrar. No entanto, se estiver quase na hora da prﾃｳxima dose, pule a dose esquecida e volte ao seu horﾃ｡rio regular. Nﾃ｣o tome duas doses ao mesmo tempo.`;
            } else if (perguntaLower.includes('ﾃ｡lcool') || perguntaLower.includes('beber')) {
                 if (remedio.toLowerCase().includes('amoxicilina')) {
                    return `Para **${remedio}**: Nﾃ｣o ﾃｩ recomendado o consumo de ﾃ｡lcool, pois pode aumentar o risco de efeitos colaterais e sobrecarregar o fﾃｭgado.`;
                }
                return `Em geral, nﾃ｣o ﾃｩ recomendado o consumo de ﾃ｡lcool durante o tratamento com medicamentos, pois pode interagir e aumentar o risco de efeitos colaterais ou diminuir a eficﾃ｡cia.`;
            } else if (perguntaLower.includes('como funciona') || perguntaLower.includes('para que serve')) {
                return `**${remedio}** geralmente ﾃｩ usado para [Inserir funﾃｧﾃ｣o genﾃｩrica do remﾃｩdio]. Para mais detalhes sobre como ele age no corpo, consulte a bula ou seu mﾃｩdico.`;
            }
            
            // Resposta genﾃｩrica se nﾃ｣o reconhecer a pergunta
            return `Desculpe, nﾃ｣o entendi sua pergunta sobre "${remedio}". Poderia reformular? Lembre-se, sou um assistente para dﾃｺvidas comuns, nﾃ｣o um substituto para o seu mﾃｩdico.`;
        }

        // Funﾃｧﾃ｣o para os botﾃｵes de sugestﾃ｣o
        function enviarPerguntaSugestao(pergunta) {
            enviarPergunta(pergunta);
        }

        // Inicia a tela de boas-vindas
        document.addEventListener('DOMContentLoaded', () => {
            mostrarTela('view-welcome');
        });

    </script>
</body>
</html>