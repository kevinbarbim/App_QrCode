<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Guardi√£o da Alta</title>
    <style>
        /* CSS simples para o bal√£o de chat */
        .chat-bubble {
            background-color: #f1f1f1;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
            align-self: flex-start;
        }
    </style>
</head>
<body class="bg-light">

    <div id="view-welcome" class="container text-center p-5 vh-100 d-flex flex-column justify-content-center">
        <h1 class="mt-3">Guardi√£o da Alta</h1>
        <p class="lead">Cuidando da sua recupera√ß√£o em casa.</p>
        <p>Aponte a c√¢mera para o QR Code da sua receita de alta para come√ßar.</p>
        <button id="btn-start-scan" class="btn btn-primary btn-lg mt-3">
            <i class="bi bi-qr-code-scan"></i> Escanear QR Code
        </button>
        
        <div id="qr-reader" style="width: 100%; margin-top: 20px; display: none;"></div>
        <p id="scan-feedback" class="text-muted small mt-2" style="display: none;">Centralizando o QR Code...</p>
    </div>

    <div id="view-receita" class="container p-3" style="display: none;">
        <h2 class="mb-3">Ol√°, <span id="nome-paciente" class="text-primary"></span>!</h2>
        <p>Sua prescri√ß√£o est√° pronta. Toque em um rem√©dio para tirar d√∫vidas.</p>
        
        <div id="lista-remedios" class="list-group">
            </div>

        <div class="d-grid gap-2 mt-4">
            <button id="btn-panico" class="btn btn-danger btn-lg">
                <i class="bi bi-exclamation-triangle-fill"></i> N√£o estou me sentindo bem
            </button>
        </div>
    </div>

    <div id="view-chat" class="container p-3" style="display: none;">
        <nav class="mb-3">
            <button id="btn-chat-voltar" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Voltar para Receita
            </button>
        </nav>
        
        <h2 class="mb-3">BulaBot Assistente</h2>
        <p>Tirando d√∫vidas sobre: <strong id="chat-remedio-nome" class="text-primary"></strong></p>
        
        <div class="d-flex flex-column">
            <div class="chat-bubble">
                Ol√°! Vi que voc√™ quer saber mais sobre <span id="chat-remedio-nome-2"></span>.
                Como posso ajudar?
            </div>
            
            <div id="chat-perguntas" class="d-grid gap-2 mt-3">
                <button class="btn btn-outline-primary" onclick="mostrarResposta('efeitos')">
                    Quais os principais efeitos colaterais?
                </button>
                <button class="btn btn-outline-primary" onclick="mostrarResposta('esqueci')">
                    Esqueci de tomar uma dose, e agora?
                </button>
                <button class="btn btn-outline-primary" onclick="mostrarResposta('posso_beber')">
                    Posso beber √°lcool durante o tratamento?
                </button>
            </div>
            
            <div id="chat-respostas" class="mt-3">
                <div id="resp-efeitos" style="display: none;">
                    <strong>Efeitos Colaterais:</strong><br>
                    Os efeitos mais comuns para a Dipirona incluem rea√ß√µes al√©rgicas, queda da press√£o e, raramente, rea√ß√µes na pele. N√°useas s√£o poss√≠veis. Se sentir algo grave, aperte o bot√£o de p√¢nico.
                </div>
                 <div id="resp-esqueci" style="display: none;">
                    <strong>Esqueci uma dose:</strong><br>
                    Tome a dose assim que lembrar. No entanto, se estiver quase na hora da pr√≥xima dose, pule a dose esquecida e volte ao seu hor√°rio regular. N√£o tome duas doses ao mesmo tempo.
                </div>
                 <div id="resp-posso_beber" style="display: none;">
                    <strong>Sobre √Ålcool:</strong><br>
                    Para este medicamento (Amoxicilina), n√£o √© recomendado o consumo de √°lcool, pois pode aumentar o risco de efeitos colaterais e sobrecarregar o f√≠gado.
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
        // --- SE√á√ÉO DE REFER√äNCIAS DA DOM ---
        const viewWelcome = document.getElementById('view-welcome');
        const viewReceita = document.getElementById('view-receita');
        const viewChat = document.getElementById('view-chat'); // NOVO
        
        const btnStartScan = document.getElementById('btn-start-scan');
        const qrReaderDiv = document.getElementById('qr-reader');
        const scanFeedback = document.getElementById('scan-feedback');
        
        const listaRemedios = document.getElementById('lista-remedios');
        const nomePaciente = document.getElementById('nome-paciente');
        const btnPanico = document.getElementById('btn-panico');

        const btnChatVoltar = document.getElementById('btn-chat-voltar'); // NOVO
        const chatRemedioNome = document.getElementById('chat-remedio-nome'); // NOVO
        const chatRemedioNome2 = document.getElementById('chat-remedio-nome-2'); // NOVO
        const chatRespostas = document.getElementById('chat-respostas'); // NOVO

        const html5QrCode = new Html5Qrcode("qr-reader");

        // --- SE√á√ÉO DE NAVEGA√á√ÉO ENTRE TELAS ---
        function mostrarTela(telaId) {
            // Esconde todas as telas
            [viewWelcome, viewReceita, viewChat].forEach(v => v.style.display = 'none');
            // Mostra a tela desejada
            document.getElementById(telaId).style.display = 'block';
        }

        // --- SE√á√ÉO DO LEITOR DE QR CODE ---
        // --- SE√á√ÉO DO LEITOR DE QR CODE ---
function onScanSuccess(decodedText, decodedResult) {
    
    // 1. Feedback imediato
    scanFeedback.innerText = "Sucesso! Processando...";
    scanFeedback.className = "text-success fw-bold";
    console.log("QR Code lido:", decodedText);

    // 2. Parar a c√¢mera √© uma opera√ß√£o ass√≠ncrona.
    // Vamos garantir que ela pare, mas n√£o vamos travar o app se der erro.
    html5QrCode.stop().then(() => {
        console.log("C√¢mera parada.");
    }).catch(err => {
        console.warn("Erro ao parar a c√¢mera, mas tudo bem, seguimos em frente.", err);
    }).finally(() => { 
        // 3. TENTAR processar os dados
        try {
            // AQUI PODE ESTAR O ERRO: Se o texto do QR Code n√£o for um JSON v√°lido, vai falhar.
            const data = JSON.parse(decodedText);
            
            // Se passou do JSON.parse, estamos bem!
            console.log("JSON processado com sucesso:", data);
            
            // 4. Renderizar os dados na tela
            renderReceita(data);
            
            // 5. Mudar para a tela da receita
            mostrarTela('view-receita');

        } catch (error) {
            // 6. Se deu erro no JSON.parse
            console.error("FALHA AO PROCESSAR O JSON!", error);
            // Isso √© o que voc√™ v√™: "Sucesso! Carregando receita..."
            // Vamos mudar a mensagem de feedback para o usu√°rio
            scanFeedback.innerText = "Erro: Este QR Code n√£o √© uma receita v√°lida.";
            scanFeedback.className = "text-danger fw-bold";
            
            // Reinicia o bot√£o de scan para o usu√°rio tentar de novo
            btnStartScan.style.display = 'block';
            qrReaderDiv.style.display = 'none';
            scanFeedback.style.display = 'block'; // Garante que a msg de erro apare√ßa
        }
    });
}

        // --- SE√á√ÉO DA TELA DE RECEITA ---
        function renderReceita(data) {
            nomePaciente.innerText = data.paciente;
            listaRemedios.innerHTML = "";
            
            data.receita.forEach(item => {
                const card = document.createElement('a'); // Mudar para 'a' (link)
                card.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                card.href = "#"; // √â um bot√£o
                
                // Salva os dados no pr√≥prio elemento para o BulaBot
                card.dataset.remedioNome = item.remedio; // NOVO
                card.dataset.id = item.id; // NOVO

                card.innerHTML = `
                    <div>
                        <h5 class="mb-1">${item.remedio}</h5>
                        <p class="mb-1 small">${item.posologia}</p>
                        <small class="text-muted">Por ${item.dias} dias.</small>
                    </div>
                    <i class="bi bi-question-circle-fill text-primary fs-3"></i> `;
                
                // NOVO: Event listener para abrir o chat
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    abrirChat(item.remedio);
                });
                
                listaRemedios.appendChild(card);
            });
        }
        
        btnPanico.addEventListener('click', () => {
            alert('ALERTA ENVIADO! üö®\n\nSua solicita√ß√£o foi enviada √† central de enfermagem. Em breve, um profissional de sa√∫de entrar√° em contato.');
        });

        // --- SE√á√ÉO DO BULABOT (CHAT) --- // NOVO
        
        btnChatVoltar.addEventListener('click', () => {
            mostrarTela('view-receita');
        });

        function abrirChat(nomeDoRemedio) {
            // Atualiza os nomes na tela de chat
            chatRemedioNome.innerText = nomeDoRemedio;
            chatRemedioNome2.innerText = nomeDoRemedio;
            
            // Reseta as respostas
            Array.from(chatRespostas.children).forEach(resp => resp.style.display = 'none');
            
            // Aqui voc√™ poderia ter uma l√≥gica para mostrar perguntas DIFERENTES
            // por rem√©dio, mas para o hackathon, as mesmas perguntas servem.
            
            // Mostra a tela de chat
            mostrarTela('view-chat');
        }

        function mostrarResposta(tipoResposta) {
            // Esconde todas as respostas primeiro
            Array.from(chatRespostas.children).forEach(resp => resp.style.display = 'none');
            
            // Mostra a resposta espec√≠fica
            // (Para a demo, as respostas s√£o gen√©ricas e est√£o hardcoded)
            // Na vida real, voc√™ teria um JSON de respostas.
            if (tipoResposta === 'efeitos') {
                document.getElementById('resp-efeitos').style.display = 'block';
            } else if (tipoResposta === 'esqueci') {
                document.getElementById('resp-esqueci').style.display = 'block';
            } else if (tipoResposta === 'posso_beber') {
                document.getElementById('resp-posso_beber').style.display = 'block';
            }
        }
      </script>
</body>
</html>